<!DOCTYPE html>
<html dir="ltr" lang="de-DE">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="lib/materialize-v1.0.0/css/materialize.min.css"  media="screen,projection">
    <style>
      body {
        display: flex;
        min-height: 100vh;
        flex-direction: column;
      }

      main {
        flex: 1 auto;
      }

      #groupList > div {
        display: grid;
        grid-column-gap: 2rem;
        grid-row-gap: 0.5rem;
        grid-template-columns: 1fr;
      }

      @media only screen and (min-width: 661px) {
        #groupList > div {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media only screen and (min-width: 993px) {
        #groupList > div {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      @media only screen and (min-width: 1325px) {
        #groupList > div {
          grid-template-columns: repeat(4, 1fr);
        }
      }
    </style>
    <title>HueBoard</title>
  </head>
  <body class="blue-grey lighten-5">
    <header>
      <nav class="blue-grey darken-3">
        <div class="nav-wrapper">
          <div class="row">
            <div class="col s12">
              <a href="#" class="brand-logo center">HueBoard</a>
            </div>
          </div>
        </div>
      </nav>
    </header>
    <main>
      <div class="container">
        <div class="row">
          <div class="col s12">
            <div id="groupList">
              <h3>Rooms</h3>
              <div id="roomList"></div>
              <h3>Zones</h3>
              <div id="zoneList"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer class="page-footer blue-grey darken-3">
      <div class="footer-copyright blue-grey darken-4">
        <div class="container">
          &copy; 2019 <a href="https://fixel.me" class="cyan-text text-lighten-1" target="_blank">
            Felix Beuster
          </a>
          <a href="#open-source-modal" class="cyan-text text-lighten-1 right modal-trigger">
            Open Source Licenses
          </a>
        </div>
      </div>
    </footer>

    <div id="open-source-modal" class="modal">
      <div class="modal-content">
        <h4 class="">Open source licenses</h4>
        <div class="collection">
          <a href="https://github.com/blargoner/jshue/blob/master/LICENSE" class="collection-item" target="_blank">
            <span class="badge"><i class="material-icons">link</i></span>
            jsHue
          </a>
          <a href="https://github.com/Dogfalo/materialize/blob/v1-dev/LICENSE" class="collection-item" target="_blank">
            <span class="badge"><i class="material-icons">link</i></span>
            MaterializeCSS
          </a>
        </div>
      </div>
      <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-blue-grey btn-flat">Close</a>
      </div>
    </div>
  </body>
  <script src="lib/jquery-3.4.1.min.js" type="text/javascript"></script>
  <script src="lib/jshue-2.1.1/src/jshue.js" type="text/javascript"></script>
  <script src="lib/materialize-v1.0.0/js/materialize.min.js" type="text/javascript"></script>
  <script type="text/javascript">
    var config = {
      pollingInterval : 5000
    };
    var hue = jsHue();
    var storage = {};

    initMaterialize();
    initHue();

    function createUsers(initUsersComplete)
    {
      var done = 0;
      storage.usernames = [];
      storage.bridges.forEach(ipaddress => {
        var timer = createUser(ipaddress);

        function createUser(ipaddress)
        {
          var bridge = hue.bridge(ipaddress);
          bridge.createUser('HueBoard').then(data => {
            var username = '';
            username = data[0].success.username;

            if (username != '')
            {
              done++;
              storage.map[ipaddress] = username;

              if (done == storage.bridges.length)
              {
                sortUsersByBridge();
                saveJsonToLocalStorage('usernames', storage.usernames);
                initUsersComplete();
              }
            }
          }).catch(e => {
            setTimeout(function(){
              createUser(ipaddress);
            }, config.pollingInterval);
          });
        }
      });
    }

    function discoverBridges()
    {
      storage.bridges = [];

      hue.discover().then(foundBridges => {
        if (foundBridges.length == 0)
        {
          console.log('No bridges found :(');
        }
        else
        {
          foundBridges.forEach(b => storage.bridges.push(b.internalipaddress));
          saveJsonToLocalStorage('bridges', storage.bridges);
          initUsers(initActiveUsers);
        }
      }).catch(e => console.log('Error finding bridges.', e));
    }

    function initActiveUsers()
    {
      for (var i = 0; i < storage.bridges.length; i++)
      {
        var bridge = hue.bridge(storage.bridges[i]);
        var user = bridge.user(storage.usernames[i]);
        storage.activeUsers.push(user);
      }

      loadGroups();
    }

    function initBridges()
    {
      if (storage.bridges != null)
      {
        storage.bridges = JSON.parse(storage.bridges);
        initUsers(initActiveUsers);
      }
      else
      {
        discoverBridges();
      }
    }

    function initHue()
    {
      storage.activeUsers = [];
      storage.bridges = localStorage.getItem('bridges');
      storage.map = {};
      storage.usernames = localStorage.getItem('usernames');

      initBridges();
    }

    function initMaterialize()
    {
      document.addEventListener('DOMContentLoaded', function() {
        var elems = document.querySelectorAll('.modal');
        var instances = M.Modal.init(elems, {});
      });
    }

    function initUsers(initUsersComplete)
    {
      if (storage.usernames != null)
      {
        storage.usernames = JSON.parse(storage.usernames);
        initUsersComplete();
      }
      else
      {
        createUsers(initUsersComplete);
      }
    }

    function loadGroups()
    {
      var done = 0;
      storage.groups = {};

      for (var i = 0; i < storage.activeUsers.length; i++)
      {
        storage.activeUsers[i].getGroups().then(data => {
          storage.groups[i] = data;
          done++;

          if (done == storage.activeUsers.length)
          {
            run();
          }
        }).catch(e => console.log('Something bad happend.', e));
      }
    }

    function mapGroupClassToFileName(name)
    {
      var fileNameMap = {
        'Attic' : 'roomsAttic',
        'Balcony' : 'roomsBalcony',
        'Barbecue' : 'roomsSocialtime',
        'Bathroom' : 'roomsBathroom',
        'Bedroom' : 'roomsBedroom',
        'Carport' : 'roomsCarport',
        'Closet' : 'roomsCloset',
        'Computer' : 'roomsComputer',
        'Dining' : 'roomsDining',
        'Downstairs' : 'zonesAreasGroundfloor',
        'Driveway' : 'roomsDriveway',
        'Front door' : 'roomsFrontdoor',
        'Garage' : 'roomsGarage',
        'Garden' : 'roomsOutdoor',
        'Guest room' : 'roomsGuestRoom',
        'Gym' : 'roomsGym',
        'Hallway' : 'roomsHallway',
        'Home' : 'tabbarHome',
        'Kids bedroom' : 'roomsKidsbedroom',
        'Kitchen' : 'roomsKitchen',
        'Laundry room' : 'roomsLaundryroom',
        'Living room' : 'roomsLiving',
        'Lounge' : 'roomsLounge',
        'Man cave' : 'roomsMancave',
        'Music' : 'otherMusic',
        'Nursery' : 'roomsNursery',
        'Office' : 'roomsOffice',
        'Other' : 'roomsOther',
        'Pool' : 'roomsPool',
        'Porch' : 'roomsPorch',
        'Reading' : 'otherReading',
        'Recreation' : 'roomsRecreation',
        'Staircase' : 'roomsStaircase',
        'Storage' : 'roomsStorage',
        'Studio' : 'roomsStudio',
        'Terrace' : 'roomsTerrace',
        'Toilet' : 'roomsToilet',
        'Top floor' : 'zonesAreasSecondFloor',
        'TV' : 'otherWatchingMovie',
        'Upstairs' : 'zonesAreasFirstfloor'
      }

      if (name in fileNameMap)
      {
        return fileNameMap[name];
      }

      return 'roomsOther';
    }

    function mapGroupClassToClassName(name)
    {
      var classMap = {
        'Attic' : 'Attic',
        'Balcony' : 'Balcony',
        'Barbecue' : 'Barbecue',
        'Bathroom' : 'Bathroom',
        'Bedroom' : 'Bedroom',
        'Carport' : 'Carport',
        'Closet' : 'Closet',
        'Computer' : 'Computer',
        'Dining' : 'Dining',
        'Downstairs' : 'Downstairs',
        'Driveway' : 'Driveway',
        'Front door' : 'FrontDoor',
        'Garage' : 'Garage',
        'Garden' : 'Garden',
        'Guest room' : 'GuestRoom',
        'Gym' : 'Gym',
        'Hallway' : 'Hallway',
        'Home' : 'Home',
        'Kids bedroom' : 'KidsBedroom',
        'Kitchen' : 'Kitchen',
        'Laundry room' : 'LaundryRoom',
        'Living room' : 'LivingRoom',
        'Lounge' : 'Lounge',
        'Man cave' : 'ManCave',
        'Music' : 'Music',
        'Nursery' : 'Nursery',
        'Office' : 'Office',
        'Other' : 'Other',
        'Pool' : 'Pool',
        'Porch' : 'Porch',
        'Reading' : 'Reading',
        'Recreation' : 'Recreation',
        'Staircase' : 'Staircase',
        'Storage' : 'Storage',
        'Studio' : 'Studio',
        'Terrace' : 'Terrace',
        'Toilet' : 'Toilet',
        'Top floor' : 'TopFloor',
        'TV' : 'TV',
        'Upstairs' : 'Upstairs'
      }

      if (name in classMap)
      {
        return classMap[name];
      }

      return 'Other';
    }

    function renderGroup(activeUser, groupNumber)
    {
      var group = storage.groups[activeUser][groupNumber];

      var $cardTitle = $('<span></span>');
      $cardTitle.addClass('card-title')
                .text(group.name);

      var $cardIcon = $('<img/>');
      var fileName = 'rooms' + group.class;
      $cardIcon.addClass('card-icon')
                .attr('src', 'assets/img/huePackPng/' + mapGroupClassToFileName(group.class) + '.png');

      var $cardContent = $('<div></div>');
      $cardContent.addClass('card-content')
                  .append($cardIcon)
                  .append($cardTitle);

      var $card = $('<div></div>');
      $card.addClass('card hoverable rooms' + mapGroupClassToClassName(group.class))
            .append($cardContent)
            .attr('data-id', activeUser + '#' + groupNumber);

      if (group.type == 'Room')
      {
        $('#roomList').append($card);
      }
      else
      {
        $('#zoneList').append($card);
      }
    }

    function renderGroupsAllUsers()
    {
      for (var activeUser in storage.groups) {
        renderGroupsSingleUser(activeUser)
      }
    }

    function renderGroupsSingleUser(activeUser)
    {
      for (var groupNumber in storage.groups[activeUser])
      {
        renderGroup(activeUser, groupNumber);
      }
    }

    function run()
    {
      renderGroupsAllUsers();
    }

    function saveJsonToLocalStorage(key, value)
    {
      localStorage.setItem(key, JSON.stringify(value));
    }

    function sortUsersByBridge() {
      storage.bridges.forEarch(ipaddress => {
        storage.usernames.push(storage.bridges[ipaddress]);
      });
    }
  </script>
</html>